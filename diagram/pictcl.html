<head>
<style>
article {
  margin:3em auto;
}
</style>

<script src="tcl.js"></script>
</head>

<h1>PicTcl Diagram</h1>

<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1">
  <defs>
    <marker id="triangle" viewBox="0 0 10 10"
          refX="1" refY="5" 
          markerUnits="strokeWidth"
          markerWidth="10" markerHeight="10"
          orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#000"/>
    </marker>
  </defs>
</svg>


<main style="width:600">

<h2>Quick Example</h2>

<article>
  <section>
    <svg id="demo-a1" stroke="black"></svg>
<script type="text/pictcl">
line
box "PicTcl"
arrow
</script>
  </section>
</article>

<article>
  <section>
    <svg id="demo-a2" stroke="black"></svg>
<script type="text/pictcl">
line -flow left
box "PicTcl"
arrow
</script>
  </section>
</article>

<article>
  <section>
    <svg id="demo-a3" stroke="black"></svg>
<script type="text/pictcl">
line -flow down
box "PicTcl"
arrow
</script>
  </section>
</article>

<article>
  <section>
    <svg id="demo-a4" stroke="black"></svg>
<script type="text/pictcl">
line -flow up
box "PicTcl"
arrow
</script>
  </section>
</article>


<article>
<section>
  <svg id="demo-1" stroke="black"></svg>
<script type="text/pictcl">
circle
circle -padx 50
move
circle
move -down
circle
circle
move -right
circle "567"
box "567"
line -flow down
</script>
</section
</article>

<aside>
  <textarea style="display:block;width:100%;margin:1em 0"></textarea>
</aside>


<pre>
circle -with west -at east
circle -right
circle -down
circle -padx 0
</pre>

</main>



<script>
PicSVG = {
  createElement: function(name, attrs){
    var xmlns = "http://www.w3.org/2000/svg";

    var svgElm = document.createElementNS(xmlns, name);
    if(attrs){
      for(var k in attrs){
        svgElm.setAttributeNS(null, k, attrs[k]);
      }
    }
    return svgElm;
  },
}

svg = document.querySelector("svg");

svg_anchor = {
  flow: 'right',
  east: {x:0, y:0}
};

svg_stack = [svg_anchor];
</script>

<script>
tcl = new TclInterp();
tcl.eval("set abc 123");


PicTcl = {
  args_text: function(args){
    for(var i=1, n=args.length; i<n; i++){
      if(args[i].content[0] != "-"){
        return args[i].content;
      } else {
        i++;
      }
    }
  },

  args_exist: function(args, name){
    for(var arg of args){
      if(arg.content == name) return true;
    }
    return false;
  },

  args_value: function(args, name, value){
    for(var i=1, n=args.length; i<n; i++){
      if(args[i].content == name) {
        value = args[i+1].content;
        break;
      }
    }
    return value;
  }
}

tcl.registerCommand("box", function(interp, args){
  var anchor = svg_stack.top();
  console.log(anchor);
  var ox, oy;

  var cx, cy, rx, ry;
  var direction = anchor.flow;

  rx = 50;
  ry = 30;

  var padx = parseInt(PicTcl.args_value(args, "-padx", 0));
  var pady = PicTcl.args_value(args, "-pady", 0);

  switch(direction){
    case "east": case "right":
      ox = anchor.east.x;
      oy = anchor.east.y;
      cx = ox + rx + padx;
      cy = oy;
      break;
    case "west": case "left":
      ox = anchor.west.x;
      oy = anchor.west.y;
      cx = ox - rx - padx;
      cy = oy;
      break;
    case 'down': case 'south':
      ox = anchor.south.x;
      oy = anchor.south.y;
      cx = ox;
      cy = oy+ry;
      break;
    case 'up': case 'north':
      ox = anchor.north.x;
      oy = anchor.north.y;
      cx = ox;
      cy = oy-ry;
      break;
  }

  var circle = PicSVG.createElement("rect", {
    x: cx-rx, y: cy-ry, width: rx*2, height: ry*2,
    fill: "none",
  });  

  svg.appendChild(circle);

  var text = PicTcl.args_text(args);
  if(text){
     var svg_text = PicSVG.createElement("text", {
       x:cx, y:cy,
       "text-anchor": "middle",
       "dominant-baseline":"middle",
     });
     svg_text.textContent = text;
     svg.appendChild(svg_text);
  }

  var new_anchor = Object.assign({}, anchor);
  new_anchor.east  = {x: cx+rx, y: cy};
  new_anchor.west  = {x: cx-rx, y: cy};
  new_anchor.south = {x: cx, y: cy+ry};
  new_anchor.north = {x: cx, y: cy-ry};
  svg_stack.push(new_anchor);
});



tcl.registerCommand("line", function(interp, args){
  var anchor = svg_stack.top();
  console.log("line", anchor);
  var ox, oy;

  var cx, cy, rx, ry;
  var direction = PicTcl.args_value(args, "-flow") || anchor.flow;

  rx = 30;
  ry = 30;

  var padx = parseInt(PicTcl.args_value(args, "-padx", 0));
  var pady = PicTcl.args_value(args, "-pady", 0);

  var x_scale = 1, y_scale = 1;

  switch(direction){
    case "east": case "right":
      ox = anchor.east.x;
      oy = anchor.east.y;
      cx = ox + rx + padx;
      cy = oy;
      ry = 0;
      break;
    case "west": case "left":
      ox = anchor.west.x;
      oy = anchor.west.y;
      cx = ox - rx - padx;
      cy = oy;
      ry = 0;
      x_scale = -1;
      break;
    case 'down': case 'south':
      ox = anchor.south.x;
      oy = anchor.south.y;
      cx = ox;
      cy = oy+ry;
      rx = 0;
      break;
    case 'up': case 'north':
      ox = anchor.north.x;
      oy = anchor.north.y;
      y_scale = -1;
      cx = ox;
      cy = oy-ry;
      rx = 0;
      break;
  }

  var shape = PicSVG.createElement("line", {
    x1: cx-rx*x_scale, y1: cy-ry*y_scale, 
    x2: cx+rx*x_scale, y2: cy+ry*y_scale, 
    fill: "none",
  });  

  if(args[0].content=="arrow"){
    shape.setAttributeNS(null, "marker-end", "url(#triangle)");
  }

  svg.appendChild(shape);

  var text = PicTcl.args_text(args);
  if(text){
     var svg_text = PicSVG.createElement("text", {
       x:cx, y:cy,
       "text-anchor": "middle",
       "dominant-baseline":"middle",
     });
     svg_text.textContent = text;
     svg.appendChild(svg_text);
  }

  var new_anchor = Object.assign({}, anchor);
  new_anchor.east  = {x: cx+rx, y: cy};
  new_anchor.west  = {x: cx-rx, y: cy};
  new_anchor.south = {x: cx, y: cy+ry};
  new_anchor.north = {x: cx, y: cy-ry};
  new_anchor.flow  = direction;
  svg_stack.push(new_anchor);
});

tcl.registerCommand("arrow", tcl.getCommand("line").func);



tcl.registerCommand("circle", function(interp, args){
  var anchor = svg_stack.top();
  console.log(anchor);
  var ox, oy;

  var cx, cy, cr;
  var direction = anchor.flow;

  cr = 50;

  var padx = parseInt(PicTcl.args_value(args, "-padx", 0));
  var pady = PicTcl.args_value(args, "-pady", 0);

  switch(direction){
    case "east": case "right":
      ox = anchor.east.x;
      oy = anchor.east.y;
      cx = ox + cr + padx;
      cy = oy;
      break;
    case 'down': case 'south':
      ox = anchor.south.x;
      oy = anchor.south.y;
      cx = ox;
      cy = oy+cr;
      break;
  }

  var circle = PicSVG.createElement("circle", {
    cx: cx, cy: cy, r: cr,
    fill: "none",
  });  

  svg.appendChild(circle);

  var text = PicTcl.args_text(args);
  if(text){
     var svg_text = PicSVG.createElement("text", {
       x:cx, y:cy,
       "text-anchor": "middle",
       "dominant-baseline":"middle",
     });
     svg_text.textContent = text;
     svg.appendChild(svg_text);
  }

  var new_anchor = Object.assign({}, anchor);
  new_anchor.east  = {x: cx+cr, y: cy};
  new_anchor.south = {x: cx, y: cy+cr};
  svg_stack.push(new_anchor);
});


tcl.registerCommand("move", function(interp, args){
  var anchor = svg_stack.top();
  var gap = 20;

  var new_anchor = Object.assign({}, anchor);

  console.log("move", args);
  if(PicTcl.args_exist(args, "-down")){
    console.log("move down");
    new_anchor.south.y += gap;
    new_anchor.flow = 'down';
  }else if(PicTcl.args_exist(args, "-right")){
    new_anchor.east.x += gap;
    new_anchor.flow = 'right';
  }else{
    new_anchor.east.x += gap;
  }


  svg_stack.push(new_anchor);
});


function PicDiagram(svg, pictcl_code){
  svg_anchor = {
    flow: 'right',
    east:  {x:0, y:0},
    south: {x:0, y:0},
    west:  {x:0, y:0},
    north: {x:0, y:0},
  };
  
  svg_stack = [svg_anchor];
  svg_stack.top = function(){
    return this[this.length-1];
  };


  window.svg = svg;
  var pictcl_code = svg.parentElement.querySelector("script[type='text/pictcl']").text;
  tcl.eval(pictcl_code);

  var padx= 10, pady=10;

  var svgbox = svg.getBBox();
  svgbox.x      -= padx;
  svgbox.width  += padx*2;
  svgbox.y      -= pady;
  svgbox.height += pady*2;

  svg.setAttribute("viewBox", [svgbox.x, svgbox.y, svgbox.width, svgbox.height].join(' '));
  svg.setAttribute("width", svgbox.width);
  svg.setAttribute("height", svgbox.height);
}

PicDiagram(document.querySelector("#demo-a1"));
PicDiagram(document.querySelector("#demo-a2"));
PicDiagram(document.querySelector("#demo-a3"));
PicDiagram(document.querySelector("#demo-a4"));

PicDiagram(document.querySelector("#demo-1"));

</script>
